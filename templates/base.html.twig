<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Welcome!{% endblock %}</title>
        {% block stylesheets %}

          <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
          <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
          
        {% endblock %}
    </head>

    <body>

    <div class="fixed-top">
    <div class="collapse" id="navbarToggleExternalContent">
    <div class="bg-dark p-4">

     <a href="{{ path('admin') }}"><button>home</button></a>

     {% if app.user %}

               <i id='bellIcon' class="fa fa-bell fa-2x" aria-hidden="true" style="color:white"></i>

               <div id='notifContent'> </div> </br>

                <div id='notifPin'> {{ app.user.pinCount }} </div> </br>

              

              <a href='{{ path("newProjectPath") }}'><button>Créer un projet</button></a>

              
              <a href='{{ path("showAllProjectsPath") }}'><button>Voir tes projets en cours</button></a>
              <a href='{{ path("showAllDoneProjectsPath") }}'><button>Voir tes projets accomplis</button></a>


            
           {%else%}
              <a href='{{ path("registerPath")}}'><button>Inscription</button></a>
           {% endif %} 

    </div>
  </div>
  <nav class="navbar navbar-dark bg-dark">

     
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span></button>


      {%if app.user%}

          <a href='{{ path("profilePagePath")}}'><button>Votre profil</button></a>

          <a href='{{ path("logoutPath")}}'><button>Déconnexion</button></a>

    {%else%}

      <a href='{{ path("loginPath")}}'><button>Connexion</button></a>

    {%endif%}
  </nav>
</div>

<br>

<br>

  
      {% block body %}{% endblock %}
                
       <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

       <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>

     
        <script>
        
        {% if app.user%}

        var notifDisplay = 'off';
        var icon = document.getElementById('bellIcon');

        var notifContent = document.getElementById('notifContent');

        var notifPin = document.getElementById('notifPin');

        var loadedNotifs = '';

        var pin;


        
                function displayPin(){

                 notifPin.innerHTML = pin;
      
                }

                 function resetPin(){

                   xrq = new XMLHttpRequest();

                   xrq.onload = function(){

                      pin = JSON.parse(this.responseText).pinCount;

                      displayPin();
 
                   }

                xrq.open('GET', '{{ path("resetNotifPinPath")}}' , true );

                xrq.send();


  

                 }


     function updatePin(){

           xrq = new XMLHttpRequest();

           xrq.onload = function(){

             pin = JSON.parse(this.responseText).pinCount;

              displayPin();

 
           }

          xrq.open('GET', '{{ path("getNotifPinPath")}}' , true );

                xrq.send();


                 }



       function updateNotifs(){
         

         xrq = new XMLHttpRequest();

         loadedNotifs = '';



         xrq.onload = function(){

            var notifContentArray = JSON.parse(this.responseText).notifContentArray;

            var notifIdArray = JSON.parse(this.responseText).notifIdArray;

            for(i=0; i<  notifIdArray.length; i++){

               loadedNotifs += '<p style="color:white">' + notifContentArray[i] +'</p></br>' + '<a  onclick = "setNotifAsDone(event)">' +  '<p value =' + notifIdArray[i] + '>Marquer comme "vu"</p></a>' ;

            
            }



        }


         xrq.open('GET', '{{path("getNotifsPath") }}', true);

         xrq.send();




      }
                   

                {% for notification in app.user.notifications %}  
                     

                    loadedNotifs += '<p style="color:white">{{ notification.content }}</p>' + '</br>' + '<a  onclick = "setNotifAsDone(event)"> <p value = "{{ notification.id }}">Marquer comme "vu"</p></a>' ;
                    
                  
                {% endfor %} 

                  


                function displayNotifs(){

                    notifContent.innerHTML = loadedNotifs;


                }
                
          

        icon.addEventListener('click', function(){
            
            if(notifDisplay == 'off'){


              resetPin();
        
             displayNotifs();      

                
             

                   notifDisplay = 'on';


            } else{

                  notifContent.innerHTML = ' ';

                   notifDisplay = 'off';

              }

        })



        function setNotifAsDone(event){

         var notifId = event.target.getAttribute('value');

          xrq = new XMLHttpRequest();

          xrq.onload = function(){

           console.log('ok');
           var notifContentArray = JSON.parse(this.responseText).notifContentArray;
           
           var notifIdArray = JSON.parse(this.responseText).notifIdArray;
        
            
            loadedNotifs = '';


            for(i=0; i < notifContentArray.length; i++){


                loadedNotifs += '<p style="color:white">' + notifContentArray[i] +'</p></br>' + '<a  onclick = "setNotifAsDone(event)">' +  '<p value =' + notifIdArray[i] + '>Marquer comme "vu"</p></a>' ;

            }

                      displayNotifs();

          }


          xrq.open('POST','{{ path("setNotifToViewedPath") }} ' , true);

          xrq.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");


          xrq.send("notifId=" + notifId);



          };
      

        {%endif%}


        {% block javascripts %}
        {% endblock %}

     
        

        </script>

              <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        
        
    </body>
</html>
